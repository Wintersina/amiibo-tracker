<!DOCTYPE html>
<html>
<head>
    <title>Amiibo Tracker</title>
    <style>
        .amiibo-card {
            border: 1px solid #ccc;
            padding: 1em;
            margin: 1em;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: space-between;
            width: 150px;
            height: 250px; /* fixed height */
            text-align: center;
            box-sizing: border-box;
        }

        .amiibo-card img {
            max-height: 100px;
            object-fit: contain;
        }
        .collected {
            background-color: #d0f0d0;
        }
    </style>
</head>
<body>
    <h1>Amiibo Collection</h1>

    {% regroup amiibos by amiiboSeries as grouped_amiibos %}

    <div id="amiibo-list">
        {% for group in grouped_amiibos %}
            <div class="game-series-group" style="border: 2px solid #666; margin-bottom: 2em; padding: 1em;">
                <h2 style="cursor: pointer;" onclick="toggleGroup(this)">
                    <span class="toggle-symbol">−</span> {{ group.grouper }}
                </h2>
                <div class="amiibo-container">
                    <div style="display: flex; flex-wrap: wrap;">
                        {% for amiibo in group.list %}
                            <div class="amiibo-card {% if amiibo.collected %}collected{% endif %}" data-id="{{ amiibo.head }}{{ amiibo.gameSeries }}{{ amiibo.tail }}">
                                <img src="{{ amiibo.image }}" alt="{{ amiibo.name }}" width="100">
                                <p>{{ amiibo.name }}</p>
                                <button onclick="toggleCollected(this)">
                                    {% if amiibo.collected %}Unmark{% else %}Collect{% endif %}
                                </button>
                            </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        {% endfor %}
    </div>

    <script>
        async function toggleCollected(button) {
            const card = button.parentElement;
            const amiiboId = card.dataset.id;
            const action = card.classList.contains('collected') ? 'uncollect' : 'collect';

            const response = await fetch('/toggle/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify({ amiibo_id: amiiboId, action: action })
            });

            if (response.ok) {
                card.classList.toggle('collected');
                button.textContent = action === 'collect' ? 'Unmark' : 'Collect';
            }
        }

        function toggleGroup(header) {
            const container = header.nextElementSibling;
            const symbol = header.querySelector('.toggle-symbol');
            if (container.style.display === 'none') {
                container.style.display = 'block';
                symbol.textContent = '−';
            } else {
                container.style.display = 'none';
                symbol.textContent = '+';
            }
        }
    </script>

</body>
</html>
