services:
  test:
    build:
      context: .
      dockerfile: Dockerfile
    entrypoint: ""  # Override the entrypoint to not run gunicorn
    command: pytest tracker/tests/ -v --tb=short
    environment:
      - DJANGO_SETTINGS_MODULE=amiibo_tracker.settings
      - PYTHONUNBUFFERED=1
    volumes:
      # Mount source code for development
      - ./tracker:/app/tracker
      - ./amiibo_tracker:/app/amiibo_tracker
    working_dir: /app

  app:
    build:
      context: .
      dockerfile: Dockerfile
    environment:
      - DJANGO_SETTINGS_MODULE=amiibo_tracker.settings
      - PORT=8080
    ports:
      - "8080:8080"
    volumes:
      - ./tracker:/app/tracker
      - ./amiibo_tracker:/app/amiibo_tracker
    working_dir: /app

  # Development server (Django runserver instead of gunicorn)
  dev:
    build:
      context: .
      dockerfile: Dockerfile
    entrypoint: ""
    command: python manage.py runserver 0.0.0.0:8080
    environment:
      - DJANGO_SETTINGS_MODULE=amiibo_tracker.settings
      - PORT=8080
    ports:
      - "8080:8080"
    volumes:
      - ./tracker:/app/tracker
      - ./amiibo_tracker:/app/amiibo_tracker
    working_dir: /app
